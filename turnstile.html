<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人机验证组件</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .turnstile-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .turnstile-modal {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 350px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .turnstile-header {
            background-color: #f5f5f5;
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .turnstile-body {
            padding: 24px;
            text-align: center;
        }

        .turnstile-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 16px;
            background-color: #f38020;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }

        .turnstile-message {
            margin-bottom: 20px;
            color: #333;
            font-size: 16px;
        }

        .turnstile-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
            text-align: center;
        }

        .turnstile-button {
            background-color: #f38020;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            width: 100%;
        }

        .turnstile-button:hover {
            background-color: #e6731b;
        }

        .turnstile-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .turnstile-footer {
            padding: 12px;
            text-align: center;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #e0e0e0;
        }

        .turnstile-success {
            color: #4CAF50;
            font-weight: bold;
            margin-top: 16px;
            display: none;
        }

        .turnstile-error {
            color: #f44336;
            font-size: 14px;
            margin-top: 12px;
            display: none;
        }

        .turnstile-loading {
            display: none;
            margin: 16px auto;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f38020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .turnstile-behavior-data {
            display: none;
        }
    </style>
</head>

<body>
    <div class="turnstile-modal">
        <div class="turnstile-header">
            <div class="turnstile-logo">✓</div>
            <h3>人机验证</h3>
        </div>
        <div class="turnstile-body">
            <p class="turnstile-message">请确认您不是机器人</p>
            <input type="text" class="turnstile-input" id="humanInput" placeholder="输入“我不是机器人”以验证" />
            <button class="turnstile-button" id="verifyButton">验证</button>
            <div class="turnstile-loading" id="loadingIndicator"></div>
            <p class="turnstile-success" id="successMessage">验证成功！正在加载内容...</p>
            <p class="turnstile-error" id="errorMessage">验证失败，请重试</p>
            <div class="turnstile-behavior-data" id="behaviorData"></div>
        </div>
        <div class="turnstile-footer">
            由安全验证系统提供保护
        </div>
    </div>

    <script>
        // 主验证类
        class TurnstileVerification {
            constructor() {
                this.behaviorScore = 0;
                this.maxScore = 100;
                this.passingScore = 75;
                this.verificationPassed = false;
                this.behaviorData = {
                    mouseMovements: [],
                    clicks: [],
                    scrolls: [],
                    keyPresses: [],
                    deviceInfo: {},
                    networkRequests: [],
                    interactionTiming: []
                };

                this.initElements();
                this.setupEventListeners();
                this.collectDeviceFingerprint();
                this.monitorNetworkRequests();
                this.startInteractionTimer();

                // 尝试无感验证
                setTimeout(() => this.tryPassiveVerification(), 2000);
            }

            initElements() {
                this.humanInput = document.getElementById('humanInput');
                this.verifyButton = document.getElementById('verifyButton');
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.successMessage = document.getElementById('successMessage');
                this.errorMessage = document.getElementById('errorMessage');
                this.behaviorDataElement = document.getElementById('behaviorData');
            }

            startInteractionTimer() {
                this.interactionStartTime = Date.now();
                this.lastActiveTime = Date.now();

                // 每5秒检查一次活动状态
                this.inactivityTimer = setInterval(() => {
                    const now = Date.now();
                    if (now - this.lastActiveTime > 10000) { // 10秒不活动
                        this.behaviorScore -= 5;
                    }
                }, 5000);
            }

            setupEventListeners() {
                // 鼠标移动跟踪（优化：节流处理）
                const recordMouseMove = (e) => {
                    this.recordMouseMovement(e);
                    this.lastActiveTime = Date.now();
                };
                document.addEventListener('mousemove', throttle(recordMouseMove, 100));

                // 点击跟踪
                document.addEventListener('click', (e) => {
                    this.lastActiveTime = Date.now();
                });

                // 滚动跟踪（优化：防抖处理）
                window.addEventListener('scroll', debounce((e) => {
                    this.recordScroll(e);
                    this.lastActiveTime = Date.now();
                }, 200), true);

                // 键盘输入跟踪
                document.addEventListener('keydown', (e) => {
                    this.recordKeyPress(e);
                    this.lastActiveTime = Date.now();
                });

                // 验证按钮点击
                this.verifyButton.addEventListener('click', () => {
                    this.verifyHuman();
                });

                // 输入框输入验证（优化：更智能的输入分析）
                this.humanInput.addEventListener('input', () => {
                    const input = this.humanInput.value;
                    if (input === "我不是机器人") {
                        this.behaviorScore += 15; // 正确输入加分
                    } else if (input.length > 0 && "我不是机器人".startsWith(input)) {
                        this.behaviorScore += 2; // 部分正确加分
                    } else if (input.length > 0) {
                        this.behaviorScore -= 5; // 错误输入减分
                    }

                    // 记录输入间隔
                    const now = Date.now();
                    if (this.lastInputTime) {
                        this.behaviorData.interactionTiming.push({
                            type: 'input',
                            interval: now - this.lastInputTime
                        });
                    }
                    this.lastInputTime = now;
                });
            }

            // 优化的行为分析方法
            recordMouseMovement(e) {
                const now = Date.now();
                const movement = {
                    x: e.clientX,
                    y: e.clientY,
                    time: now,
                    speed: 0,
                    acceleration: 0,
                    pathLength: 0
                };

                if (this.behaviorData.mouseMovements.length > 0) {
                    const last = this.behaviorData.mouseMovements[this.behaviorData.mouseMovements.length - 1];
                    const timeDiff = (now - last.time) / 1000;
                    if (timeDiff > 0) {
                        const distance = Math.sqrt(
                            Math.pow(movement.x - last.x, 2) +
                            Math.pow(movement.y - last.y, 2)
                        );
                        movement.speed = distance / timeDiff;
                        movement.pathLength = last.pathLength + distance;

                        if (this.behaviorData.mouseMovements.length > 1) {
                            const lastSpeed = last.speed;
                            movement.acceleration = (movement.speed - lastSpeed) / timeDiff;
                        }
                    }
                }

                this.behaviorData.mouseMovements.push(movement);

                // 实时分析鼠标行为
                if (this.behaviorData.mouseMovements.length % 10 === 0) {
                    this.analyzeMouseBehavior();
                }
            }

            // 优化的分析方法
            analyzeMouseBehavior() {
                const movements = this.behaviorData.mouseMovements;
                if (movements.length < 5) return;

                // 1. 检查鼠标速度变化（人类通常有变化）
                const speeds = movements.map(m => m.speed).filter(s => s > 0);
                const speedVariation = this.calculateVariation(speeds);

                // 人类通常有中等速度变化
                if (speedVariation > 0.3 && speedVariation < 1.5) {
                    this.behaviorScore += 8;
                } else if (speedVariation <= 0.3) {
                    this.behaviorScore -= 10; // 过于规律可能是机器人
                }

                // 2. 检查加速度模式
                const accelerations = movements.map(m => m.acceleration).filter(a => !isNaN(a));
                const accelPattern = this.detectPattern(accelerations);

                // 人类加速度通常不规则
                if (accelPattern.regularity < 0.4) {
                    this.behaviorScore += 5;
                }

                // 3. 检查轨迹特征
                const recentMovements = movements.slice(-20);
                if (recentMovements.length >= 3) {
                    const linearity = this.checkMovementLinearity(recentMovements);
                    const curvature = this.calculatePathCurvature(recentMovements);

                    // 人类轨迹通常既不完全直线也不完全曲线
                    if (linearity > 0.4 && linearity < 0.9) {
                        this.behaviorScore += 5;
                    }

                    // 中等曲率加分
                    if (curvature > 0.2 && curvature < 0.8) {
                        this.behaviorScore += 3;
                    }
                }

                // 4. 检查移动路径长度与直线距离比
                if (movements.length >= 10) {
                    const start = movements[0];
                    const end = movements[movements.length - 1];
                    const straightDist = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
                    const pathRatio = end.pathLength / (straightDist || 1);

                    // 人类通常有1.2-2.5的路径比
                    if (pathRatio > 1.2 && pathRatio < 2.5) {
                        this.behaviorScore += 5;
                    }
                }
            }

            // 新增方法：计算路径曲率
            calculatePathCurvature(movements) {
                if (movements.length < 3) return 0;

                let totalAngle = 0;
                for (let i = 1; i < movements.length - 1; i++) {
                    const prev = movements[i - 1];
                    const curr = movements[i];
                    const next = movements[i + 1];

                    const v1 = { x: curr.x - prev.x, y: curr.y - prev.y };
                    const v2 = { x: next.x - curr.x, y: next.y - curr.y };

                    const dot = v1.x * v2.x + v1.y * v2.y;
                    const mag1 = Math.sqrt(v1.x * v1.x + v1.y * v1.y);
                    const mag2 = Math.sqrt(v2.x * v2.x + v2.y * v2.y);

                    const angle = Math.acos(dot / (mag1 * mag2 || 1));
                    totalAngle += angle;
                }

                return totalAngle / (movements.length - 2);
            }

            // 优化的验证流程
            verifyHuman() {
                // 检查输入是否正确
                if (this.humanInput.value !== "我不是机器人") {
                    this.showError("请输入正确的验证文本");
                    return;
                }

                this.showLoading();

                // 综合评分（优化评分算法）
                setTimeout(() => {
                    const finalScore = this.calculateFinalScore();
                    const confidence = this.calculateConfidenceLevel();

                    if (finalScore >= this.passingScore && confidence >= 0.7) {
                        this.passVerification();
                    } else {
                        let errorMsg = "验证失败";
                        if (confidence < 0.7) errorMsg += "：行为模式异常";
                        if (finalScore < this.passingScore * 0.5) errorMsg += "：分数过低";

                        this.showError(errorMsg);
                        this.behaviorScore = Math.max(0, this.behaviorScore - 10); // 失败后降分
                    }
                }, 1500);
            }

            // 新增方法：计算置信度
            calculateConfidenceLevel() {
                let confidence = 0.5; // 基础置信度

                // 1. 检查鼠标行为置信度
                if (this.behaviorData.mouseMovements.length >= 20) {
                    const recentMoves = this.behaviorData.mouseMovements.slice(-20);
                    const linearity = this.checkMovementLinearity(recentMoves);
                    const curvature = this.calculatePathCurvature(recentMoves);

                    // 理想的人类线性度和曲率范围
                    if (linearity > 0.4 && linearity < 0.9 && curvature > 0.2 && curvature < 0.8) {
                        confidence += 0.2;
                    }
                }

                // 2. 检查输入模式置信度
                if (this.behaviorData.keyPresses.length >= 10) {
                    const intervals = [];
                    for (let i = 1; i < this.behaviorData.keyPresses.length; i++) {
                        intervals.push(this.behaviorData.keyPresses[i].time - this.behaviorData.keyPresses[i - 1].time);
                    }
                    const variation = this.calculateVariation(intervals);

                    // 人类输入间隔通常有中等变化
                    if (variation > 0.4 && variation < 1.2) {
                        confidence += 0.15;
                    }
                }

                // 3. 检查设备指纹置信度
                if (this.behaviorData.deviceInfo.fonts.length >= 5 &&
                    this.behaviorData.deviceInfo.plugins.length > 0) {
                    confidence += 0.1;
                }

                // 4. 检查活动时间置信度
                const activeTime = (this.lastActiveTime - this.interactionStartTime) / 1000;
                if (activeTime > 3 && activeTime < 60) { // 合理交互时间
                    confidence += 0.05;
                }

                return Math.min(1, confidence); // 不超过1
            }

            // 其他方法保持不变...
        }

        // 新增工具函数：节流
        function throttle(func, limit) {
            let lastFunc;
            let lastRan;
            return function () {
                const context = this;
                const args = arguments;
                if (!lastRan) {
                    func.apply(context, args);
                    lastRan = Date.now();
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(function () {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(context, args);
                            lastRan = Date.now();
                        }
                    }, limit - (Date.now() - lastRan));
                }
            };
        }

        // 新增工具函数：防抖
        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // 初始化验证
        document.addEventListener('DOMContentLoaded', () => {
            const turnstile = new TurnstileVerification();

            // 暴露API供外部调用
            window.Turnstile = {
                getStatus: () => turnstile.getVerificationStatus(),
                reset: () => {
                    document.querySelector('.turnstile-error').style.display = 'none';
                    document.getElementById('humanInput').value = '';
                    document.getElementById('verifyButton').style.display = 'block';
                    document.getElementById('verifyButton').disabled = false;
                }
            };
        });
    </script>

</body>

</html>